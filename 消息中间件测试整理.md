# 消息中间件测试说明





## 单元测试

### Producer

| Producer                                         | Producer                               | 构造函数               |      |
| ------------------------------------------------ | -------------------------------------- | ---------------------- | ---- |
| setTopic，setTopicByRPC，delTopic，delTopicByRPC | 创建主题，删除主题放在同一个测试案例中 | 主题已存在和主题不存在 |      |
| getTopic，getTopicByRPC                          | 查找主题                               | 主题已存在和主题不存在 |      |
| post，shortsendTask，longsendTask                | 发送消息                               | 批量发送和单笔发送     |      |
| storeMeta，storeRPCMeta                          | 存储nameserver返回的Broker组           |                        |      |

### LockFreeQueue

| 无锁队列      | push，batchpush | 插入消息             | 批量和单笔 |
| ------------- | --------------- | -------------------- | ---------- |
| delQ，freeQ   | 删除队列        |                      |            |
| createQ       | 创建队列        |                      |            |
| pop，batchpop | 取出消息        | 批量和单笔           |            |
| findQ         | 查找队列        | 队列存在和队列不存在 |            |

### Consumer

| 消费者客户端    | Consumer    | 构造函数   |      |
| --------------- | ----------- | ---------- | ---- |
| pullbatch，pull | 接收消息    | 单笔和批量 |      |
| commit          | 消息消费ACK |            |      |
| getTopicMeta    | 订阅主题    |            |      |

### Broker

| Broker                                             | addTopic，TopicCmdService::addTopic，addTopicRyRpc | 新增主题 | 接收消息的主题不存在 |
| -------------------------------------------------- | -------------------------------------------------- | -------- | -------------------- |
| delTopic，TopicCmdService::delTopic, delTopicByRpc | 删除主题                                           |          |                      |
| writemeta                                          | 顺序写元数据文件                                   |          |                      |
| writedbmeta                                        | KV存储写元数据文件                                 |          |                      |
| readdbmeta                                         | KV存储模式读元数据文件                             |          |                      |
| readmeta                                           | 顺序写模式读元数据文件                             |          |                      |
| insertToDB，insertBatchToDB                        | 数据持久化KV存储方式，分为单笔和批量               |          |                      |
| flushbatch，flush                                  | 数据持久化顺序写方式，分为单笔和批量               |          |                      |
| pullFromDB，pullbatchFromDB，Organize              | 数据消费KV存储方式                                 |          |                      |
| pull，pullbatch，Organize                          | 数据消费顺序写模式                                 |          |                      |
| Broker                                             | 初始化构造函数                                     |          |                      |
| onBatchClientRequest                               | broker服务                                         |          |                      |
| onClientRequest                                    | broker服务                                         |          |                      |
| onServerRequest                                    | broker服务                                         |          |                      |
| onNameServerRequest                                | broker服务                                         |          |                      |
| recover                                            | 重启后恢复元数据                                   |          |                      |
| heartbeatToNameServer                              | 心跳                                               |          |                      |

### Message

| 消息Message | getsend      | 消息内容拼接 |      |
| ----------- | ------------ | ------------ | ---- |
| append      | 消息内容拼接 |              |      |

### Spinlock

| Spinlock    | spin_lock |      |      |
| ----------- | --------- | ---- | ---- |
| spin_unlock |           |      |      |
| Spinlock    |           |      |      |

### NameServer

| 协调者                                         | NameServer           | 构造函数 |      |
| ---------------------------------------------- | -------------------- | -------- | ---- |
| addtopic，TopicCmdService::addTopic            | 生产者添加主题。     |          |      |
| delTopic，TopicCmdService::delTopic            | 生产者删除主题       |          |      |
| lookup，TopicCmdService::findTopic             | 生产者查找主题       |          |      |
| BrokerCmdServiceImpl::addBrokerGroup           | 用户增加BrokerGroup  |          |      |
| BrokerCmdServiceImpl::delBrokerGroup           | 用户删除BrokerGroup  |          |      |
| BrokerCmdServiceImpl::delBroker                | 用户删除Broker       |          |      |
| BrokerCmdServiceImpl::addBroker                | 用户新增Broker       |          |      |
| getresult                                      | 协调者将请求结果返回 |          |      |
| Registry，unRegistry，HARegistry，unHARegistry | 更新响应的元数据     |          |      |

### Console

| console 前台               | registerBrokerGroupToNameServer | 注册BrokerGroup |      |
| -------------------------- | ------------------------------- | --------------- | ---- |
| delBrokerGroupToNameServer | 删除BrokerGroup                 |                 |      |
| registerBrokerToNameServer | 注册Broker                      |                 |      |
| delBrokerToNameServer      | 删除Broker                      |                 |      |

## 流程测试



![image-20200918164520788](C:\Users\lwl\AppData\Roaming\Typora\typora-user-images\image-20200918164520788.png)



注册Broker集群，Prodecer发数据，Consumer取数据









## 压力测试

### Broker压力测试

#### 普通测试

| 序号 | 测试场景                       | 数量级 | 结果 |
| ---- | ------------------------------ | ------ | ---- |
| 1    | 一个线程顺序push多条数据       | 500    | 通过 |
| 2    | 一个线程顺序pull多条数据       | 500    | 通过 |
| 3    | 一个线程顺序写，一个线程顺序读 | 500    | 通过 |
| 4    | 多个线程顺序send_message       | 500    | 通过 |
| 5    | 多个线程顺序pull               | 500    | 通过 |
| 6    | 多个线程同时写，多个线程同时读 | 500    | 通过 |

#### 增大压力

1. ```shell
   ./googletest/ut_broker 10000 0 0 0 0 0 > 1
   ```

   ![image-20200918164002698](C:\Users\lwl\AppData\Roaming\Typora\typora-user-images\image-20200918164002698.png)

2. ```shell
   ./googletest/ut_broker 0 10000 0 0 0 0
   ```

   ![image-20200918164224759](C:\Users\lwl\AppData\Roaming\Typora\typora-user-images\image-20200918164224759.png)

### NameServer 压力测试

1. addBrokerGroup

2. delBrokerGroup

3. addBroker

4. delBroker

5. setTopicByRpc

6. getTopicByRpc

7. delTopicByRpc

   以上小数据量不会出错，大数据量会报如下错误：

   ![image-20200918164420523](C:\Users\lwl\AppData\Roaming\Typora\typora-user-images\image-20200918164420523.png)





## 问题

### Broker相关

- Topic被删除，再被重新添加回来时，会出现重复消费的问题。
- Topic被删除，再被重新添加回来时，会出现重复消费的问题。

### NameServer相关

- Topic Manager（topicname和groupname的映射）中，会出现一个Topic关联多个相同的groupname的情况，没有相关的检查去重机制。



